<%-include("../../views/partials/user/header.ejs")%>

<head>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp,container-queries"></script>


  <style>
    .error-message {
  color: red;
  font-size: 0.8em;
  margin-top: 5px;
  display: block;
}

.checkout-form-list input.error {
  border-color: red;
}


    .add-address-button {
      margin-top: 20px;
      text-align: right;
    }
    .address-cards {
      margin-top: 20px;
    }
    .address-card {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      position: relative;
    }
    .address-card .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: red;
      cursor: pointer;
    }
    .address-card .select-address {
      margin-right: 10px;
    }
    .checkout-form-list {
      border-radius: 12px;
    }
    * {
      box-sizing: border-box;
      /* margin: 0; */
      /* padding: 0; */
    }
    /* body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }  */
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(255, 127, 0, 0.1);
      display: flex;
      width: 100%;
      max-width: 500px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(255, 127, 0, 0.15);
    }
    .card-select {
      background-color: #f13500f0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .card-content {
      padding: 15px;
      flex-grow: 1;
    }
    .card-header {
      color: #ff5900;
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .card-body {
      font-size: 0.9em;
      color: #333;
    }
    .field {
      margin-bottom: 5px;
    }
    .required::after {
      content: "*";
      color: #ff7f00;
      margin-left: 2px;
    }
    .radio-container {
      display: inline-block;
      position: relative;
      cursor: pointer;
      user-select: none;
      width: 20px;
      height: 20px;
    }
    .radio-container input {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }
    .checkmark {
      position: absolute;
      top: 0;
      left: 0;
      height: 20px;
      width: 20px;
      background-color: #fff;
      border-radius: 50%;
      border: 2px solid #fff;
    }
    .radio-container:hover input ~ .checkmark {
      background-color: #ffe0b3;
    }
    .radio-container input:checked ~ .checkmark {
      background-color: #fff;
    }
    .checkmark:after {
      content: "";
      position: absolute;
      display: none;
    }
    .radio-container input:checked ~ .checkmark:after {
      display: block;
    }
    .radio-container .checkmark:after {
      top: 3px;
      left: 3px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff7f00;
    }
    @media (max-width: 600px) {
      .card {
        flex-direction: column;
      }
      .card-select {
        width: 100%;
        padding: 5px;
      }
    }
    .popup {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%) scale(0.95);
      color: #ffffff;
      padding: 6px 12px;
      border-radius: 9999px;
      font-size: 14px;
      font-weight: 400;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      max-width: 90%;
      width: auto;
      white-space: nowrap;
    }
    .popup.show {
      opacity: 1;
      transform: translateX(-50%) scale(1);
      z-index: 1000;
    }
    .popup.success {
      background-color: #049b06f3;
      z-index: 1000;
    }
    .popup.error {
      background-color: #000000;
      z-index: 1000;
    }
    .popup.success:hover {
      background-color: #059669;
    }
    .popup.error:hover {
      background-color: #dc2626;
    }
  </style>
</head>
<div id="successPopup" class="popup success">
  <div class="icon-wrapper">
    <svg
      class="icon"
      viewBox="0 0 24 24"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M20 6L9 17L4 12"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
    </svg>
  </div>
  Success! Action recorded
</div>

<div id="errorPopup" class="popup error">
  <div class="icon-wrapper">
    <svg
      class="icon"
      viewBox="0 0 24 24"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M18 6L6 18M6 6L18 18"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
    </svg>
  </div>
  Error! Action failed
</div>
<!--....................................POP UP MESSSAGE ............................................................. -->
<main>
  <!-- breadcrumb-area-start -->
  <section class="breadcrumb-area" style="background-color: #afa493;">
    <div class="container">
      <div class="row">
        <div class="col-xl-12">
          <div class="breadcrumb-text text-center">
            <h1>Checkout</h1>
            <ul class="breadcrumb-menu">
              <li><a href="/">home</a></li>
              <li><span>Checkout</span></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- breadcrumb-area-end -->

  <!-- coupon-area start -->
  <section class="coupon-area pt-100 pb-30">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <div class="coupon-accordion">
            <!-- ACCORDION START -->
            <h3>
              Do you want to see available Coupons ?
              <span id="showlogin">Click here to see</span>
            </h3>
            <div id="checkout-login" class="coupon-content">
              <div class="coupon-info">
                <h2 class="coupon-text" style="color: darkorange;">Available Coupons</h2>
                <form action="#">
                  <%coupons.forEach(coupon=>{%>
                  <p class="form-row-first" style="color: rgb(255, 25, 0);">
                    <label
                      >Minimum purchase amount <%=coupon.minimumPrice%>---get <%=coupon.offerPrice%>% OFF<span
                        class="required"
                        >*</span
                      ></label
                    >
                    <span></span>
                  <input type="text" value="<%=coupon.name%>" readonly />
                  </p>
                 
                  <%})%>
                </form>
              </div>
            </div>
            <!-- ACCORDION END -->
          </div>
        </div>
        <div class="col-md-6">
          <div class="coupon-accordion">
            <!-- ACCORDION START -->
            <h3>
              Have a coupon?
              <span id="showcoupon">Click here to enter your code</span>
            </h3>
            <div id="checkout_coupon" class="coupon-checkout-content">
              <div id="coupon-section">
                <!-- Input field and Apply button -->
                <div id="apply-coupon-section">
                  <input type="text" id="coupon-code" placeholder="Enter Coupon Code" />
                  <button id="apply-coupon-btn">Apply Coupon</button>
                  <p id="coupon-message"></p>
                </div>
              
                <!-- Remove button, initially hidden -->
                <div id="remove-coupon-section" style="display: none;">
                  <p id="applied-coupon-message"></p>
                  <button id="remove-coupon-btn">Remove Coupon</button>
                </div>
              </div>
              
            </div>
            <!-- ACCORDION END -->
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- coupon-area end -->
  <!-- checkout-area start -->
  <section class="checkout-area pb-70">
    <div class="container">
      <div class="row">
        <div class="col-lg-6">
          <div class="checkbox-form">
            <h3>Billing Details</h3>
            <!-- <div class="row">
                                <div class="col-md-12">
                                    <div class="country-select">
                                        <label>Country <span class="required">*</span></label>
                                        <select>
                                            <option value="volvo">bangladesh</option>
                                            <option value="saab">Algeria</option>
                                            <option value="mercedes">Afghanistan</option>
                                            <option value="audi">Ghana</option>
                                            <option value="audi2">Albania</option>
                                            <option value="audi3">Bahrain</option>
                                            <option value="audi4">Colombia</option>
                                            <option value="audi5">Dominican Republic</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="checkout-form-list">
                                        <label>First Name <span class="required">*</span></label>
                                        <input type="text" placeholder="" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="checkout-form-list">
                                        <label>Last Name <span class="required">*</span></label>
                                        <input type="text" placeholder="" />
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="checkout-form-list">
                                        <label>Company Name</label>
                                        <input type="text" placeholder="" />
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="checkout-form-list">
                                        <label>Address <span class="required">*</span></label>
                                        <input type="text" placeholder="Street address" />
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="checkout-form-list">
                                        <input type="text" placeholder="Apartment, suite, unit etc. (optional)" />
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="checkout-form-list">
                                        <label>Town / City <span class="required">*</span></label>
                                        <input type="text" placeholder="Town / City" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="checkout-form-list">
                                        <label>State / County <span class="required">*</span></label>
                                        <input type="text" placeholder="" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="checkout-form-list">
                                        <label>Postcode / Zip <span class="required">*</span></label>
                                        <input type="text" placeholder="Postcode / Zip" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="checkout-form-list">
                                        <label>Email Address <span class="required">*</span></label>
                                        <input type="email" placeholder="" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="checkout-form-list">
                                        <label>Phone <span class="required">*</span></label>
                                        <input type="text" placeholder="Postcode / Zip" />
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="checkout-form-list create-acc">
                                        <input id="cbox" type="checkbox" />
                                        <label>Create an account?</label>
                                    </div>
                                    <div id="cbox_info" class="checkout-form-list create-account">
                                        <p>Create an account by entering the information below. If you are a returning
                                            customer please login at the top of the page.</p>
                                        <label>Account password <span class="required">*</span></label>
                                        <input type="password" placeholder="password" />
                                    </div>
                                </div>
                            </div> -->
            <div class="different-address">
              <div class="ship-different-title">
                <h3>
                  <label>Add new address?</label>
                  <input id="ship-box" type="checkbox" style="margin-left: -20px;margin-top: 5px;" />
                </h3>
              </div>
              <form action=""></form>
              <div id="ship-box-info">
                <form id="addressForm">
                  <input type="hidden" id="addressId" name="addressId" />
                  <div class="row">
                    <div class="col-md-6">
                      <div class="checkout-form-list">
                        <label>Full Name <span class="required">*</span></label>
                        <input
                          type="text"
                          id="fullName"
                          name="fullName"
                          placeholder=""
                          data-validate="required"
                        />
                        <span class="error-message" id="fullName-error"></span>
                      </div>
                    </div>
                
                    <div class="col-md-12">
                      <div class="checkout-form-list">
                        <label>
                          Street Address
                          <span class="required">*</span>
                        </label>
                        <input
                          type="text"
                          id="streetAddress"
                          name="streetAddress"
                          required
                          placeholder="Street address"
                          data-validate="required"
                        />
                        <span class="error-message" id="streetAddress-error"></span>
                      </div>
                    </div>
                    <div class="col-md-12">
                      <div class="checkout-form-list">
                        <label>Town / City <span class="required">*</span></label>
                        <input
                          type="text"
                          id="city"
                          name="city"
                          required
                          placeholder="Town / City"
                          data-validate="required"
                        />
                        <span class="error-message" id="city-error"></span>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="checkout-form-list">
                        <label>State / County <span class="required">*</span></label>
                        <input
                          type="text"
                          id="state"
                          name="state"
                          required
                          placeholder=""
                          data-validate="required"
                        />
                        <span class="error-message" id="state-error"></span>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="checkout-form-list">
                        <label>PIN code <span class="required">*</span></label>
                        <input
                          type="text"
                          id="pinCode"
                          name="pinCode"
                          required
                          placeholder="Postcode"
                          data-validate="required,pincode"
                          maxlength="6"
                        />
                        <span class="error-message" id="pinCode-error"></span>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="checkout-form-list">
                        <label>Phone <span class="required">*</span></label>
                        <input
                          type="tel"
                          id="phone"
                          name="phone"
                          required
                          placeholder="Phone number"
                          data-validate="required,phone"
                          maxlength="10"
                        />
                        <span class="error-message" id="phone-error"></span>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="checkout-form-list">
                        <label>
                          Alternative Phone
                          <span class="required">*</span>
                        </label>
                        <input
                          type="tel"
                          id="altPhone"
                          name="altPhone"
                          required
                          placeholder=" Alternative Phone number"
                          data-validate="required,phone"
                          maxlength="10"
                        />
                        <span class="error-message" id="altPhone-error"></span>
                      </div>
                    </div>
                    <div class="add-address-button" style="padding: 15px">
                      <button
                        type="submit"
                        id="addAddressBtn"
                        class="btn btn-primary"
                        style="background-color: rgb(0, 155, 18)"
                      >
                        Add Address
                      </button>
                    </div>
                  </div>
                </form>
                
              </div>
            </div>
            <!-- ......................... -->
            <div class="cards-container" style="padding: 10px;">
              <%addresses.forEach((address)=>{%>
              <div class="card">
                <div class="card-select">
                  <label class="radio-container">
                    <input
                      type="radio"
                      name="selectedAddress"
                      value="<%=address._id%>"
                    />
                    <span class="checkmark"></span>
                  </label>
                </div>
                <div class="card-content">
                  <div class="card-header"><%=address.name%></div>
                  <div class="card-body">
                    <div class="field required">
                      <%=address.streetAddress%>,
                    </div>
                    <div class="field"><%=address.city%></div>
                    <div class="field required"><%=address.state%> -</div>
                    <div class="field required"><%=address.pincode%></div>
                    <div class="field"><%=address.phone%></div>
                    <div class="field required"><%=address.altphone%></div>
                  </div>
                </div>
                <button
                  onclick="editAddress('<%=address._id%>')"
                  class="w-8 h-8 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition duration-300 ease-in-out transform hover:scale-110 focus:outline-none"
                  title="Edit"
                  type="submit"
                  style="margin-left: 8px; margin-bottom: 4px;"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    class="w-4 h-4 mx-auto"
                  
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"
                    />
                  </svg>
                </button>
              </div>

              , <%})%>
            </div>
            <!-- ........................... -->
          </div>
        </div>

        <div class="col-lg-6">
          <div class="your-order mb-30">
            <h3>Your order</h3>
            <div class="your-order-table table-responsive">
              <table>
                <thead>
                  <tr>
                    <th class="product-name">Product</th>
                    <th class="product-total">Total</th>
                  </tr>
                </thead>
                <tbody>
                  <% items.forEach((item) => { %>
                  <tr class="cart_item">
                    <td class="product-name">
                      <%= item.productId.productName %> - <%= item.size %>
                      <strong class="product-quantity">
                        × <%= item.quantity %></strong
                      >
                    </td>
                    <!-- <td class="product-total"> -->
                    <!-- Show salePrice instead of regular price -->
                    <!-- <span class="amount">$<%= item.salePrice.toFixed(2) %></span>
                        </td> -->
                    <td class="product-total">
                      <!-- Total price for the item -->
                      <span class="amount"
                        >$<%= item.totalPrice.toFixed(2) %></span
                      >
                    </td>
                  </tr>
                  <% }); %>
                </tbody>

                <tfoot>
                  <tr class="order-discount">
                    <th>Total Discount</th>
                    <td>
                      <strong
                        ><span class="amount"
                          >-$<%= totalDiscount %></span
                        ></strong
                      >
                    </td>
                  </tr>
                  <tr class="cart-subtotal">
                    <th>Cart Subtotal</th>
                    <td><span class="amount">$<%= total %></span></td>
                  </tr>
                  <tr class="shipping">
                    <th>Shipping</th>
                    <td>
                      <ul>
                        <!-- <li>
                            <input type="radio" />
                            <label>
                              Flat Rate: <span class="amount">$7.00</span>
                            </label>
                          </li> -->
                        <li>
                          <label>Free Shipping:</label>
                        </li>
                        <li></li>
                      </ul>
                    </td>
                  </tr>
                  <tr class="order-discount">
                    <th>Coupon Discount</th>
                    <td>
                        <strong>
                            <span class="amount" id="couponDiscount">-$<%= couponData.discount || 0 %>.00</span>
                        </strong>
                    </td>
                </tr>
                  <tr class="order-total">
                    <th>Order Total</th>
                    <td>
                      <div id="order-summary">
                  
                      </div>
                      <strong><span style="font-size: 20px;">₹</span><span class="amount" id="finalTotal"><%= couponData.finalTotal || total %></span></strong>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div id="addressCards" class="address-cards">
              <!-- Address cards will be dynamically added here -->
            </div>

            <div class="payment-method">
              <div class="accordion" id="accordionExample">
                <div class="card">
                  <div class="card-header" id="headingOne">
                    <h5 class="mb-0">
                      <input
                      type="radio"
                      name="paymentMethod"
                      id="walletPayment"
                      value="wallet"
                      style="margin-right: 10px"
                    />
                    <button
                      class="btn-link"
                      type="button"
                      data-toggle="collapse"
                      data-target="#collapseOne"
                      aria-expanded="true"
                      aria-controls="collapseOne"
                    >
                      Wallet
                    </button>                    
                    </h5>
                  </div>
                </div>
                <div class="card">
                  <div class="card-header" id="headingTwo">
                    <h5 class="mb-0">
                      <input
                        type="radio"
                        name="paymentMethod"
                        id="cashonDelivery"
                        value="cashonDelivery"
                        style="margin-right: 10px"
                      />
                      <button
                        class="btn-link collapsed"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseTwo"
                        aria-expanded="false"
                        aria-controls="collapseTwo"
                      >
                        Cash On delivery
                      </button>
                    </h5>
                  </div>
                </div>
                <div class="card">
                  <div class="card-header" id="headingThree">
                    <h5 class="mb-0">
                      <input
                        type="radio"
                        name="paymentMethod"
                        id="paypal"
                        value="paypal"
                        style="margin-right: 10px"
                      />
                      <button
                        class="btn-link collapsed"
                        type="button"
                        data-toggle="collapse"
                        data-target="#collapseThree"
                        aria-expanded="false"
                        aria-controls="collapseThree"
                      >
                        PayPal
                      </button>
                    </h5>
                  </div>
                </div>
              </div>
              <div class="order-button-payment mt-20">
                <button type="submit" class="btn theme-btn">Place order</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- checkout-area end -->
</main>

<%-include("../../views/partials/user/footer.ejs")%>
<script>
  // ---------------------------------- Address Form Submission ----------------------------------
  const addressForm = document.getElementById("addressForm");
let finalAmount = null;

function validateField(field) {
  const value = field.value.trim();
  const validations = field.dataset.validate.split(',');
  let error = '';

  validations.forEach(validation => {
    switch (validation) {
      case 'required':
        if (value === '') {
          error = 'This field is required';
        }
        break;
      case 'pincode':
        if (!/^[1-9][0-9]{5}$/.test(value)) {
          error = 'Please enter a valid 6-digit PIN code (should not start with 0)';
        }
        break;
      case 'phone':
        if (!/^[6-9]\d{9}$/.test(value)) {
          error = 'Please enter a valid 10-digit phone number (should start with 6, 7, 8, or 9)';
        }
        break;
    }
  });

  const errorElement = document.getElementById(`${field.id}-error`);
  errorElement.textContent = error;
  field.classList.toggle('error', error !== '');
  return error === '';
}

function validateForm() {
  const fields = addressForm.querySelectorAll('[data-validate]');
  let isValid = true;

  fields.forEach(field => {
    if (!validateField(field)) {
      isValid = false;
    }
  });

  return isValid;
}

addressForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  console.log("Address function triggered");

  if (validateForm()) {
    const formData = new FormData(addressForm);
    const addressData = Object.fromEntries(formData.entries());

    try {
      if (addressData.addressId) {
        await axios.put(`/address/edit/${addressData.addressId}`, addressData);
      } else {
        const response = await axios.post('/address/add', addressData);
        console.log(response);
      }
      window.location.reload();
    } catch (error) {
      console.error('Error submitting form:', error);
      // Handle error (e.g., show error message to user)
    }
  }
});

// Add blur event listeners to all fields for real-time validation
const fields = addressForm.querySelectorAll('[data-validate]');
fields.forEach(field => {
  field.addEventListener('blur', () => validateField(field));
});

async function editAddress(addressId) {
  console.log("Edit address function triggered", addressId);

  try {
    const response = await axios.get(`/addressesOfUser/${addressId}`);
    const address = response.data.addressData.address[0];

    const shipBox = document.getElementById('ship-box');
    const shipBoxInfo = document.getElementById('ship-box-info');

    if (!shipBox.checked) {
      shipBox.checked = true;
      shipBoxInfo.style.display = "block";
    }

    document.getElementById('addressId').value = addressId;
    document.getElementById('fullName').value = address.name;
    document.getElementById('streetAddress').value = address.streetAddress;
    document.getElementById('city').value = address.city;
    document.getElementById('state').value = address.state;
    document.getElementById('pinCode').value = address.pincode;
    document.getElementById('phone').value = address.phone;
    document.getElementById('altPhone').value = address.altphone;

    document.getElementById('addAddressBtn').textContent = 'Update Address';
  } catch (error) {
    console.error('Error fetching address details:', error);
  }
}


  // ---------------------------------- Order Placement ----------------------------------
  document.querySelector('.order-button-payment button').addEventListener("click", async (e) => {
    e.preventDefault();
    console.log('Place order button clicked');

     // Check authentication status before proceeding
     try {
        const authResponse = await axios.get('/check-auth', {
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (authResponse.data.redirect) {
            window.location.href = authResponse.data.redirect;
            return;
        }
    } catch (error) {
        console.error("Authentication check failed:", error);
        window.location.href = '/signup'
        return;
    }

    const addressRadio = document.querySelector('input[name="selectedAddress"]:checked');
    if (!addressRadio) {
      showErrorPopup("Please select an address");
      return;
    }

    const selectedAddress = addressRadio.value;
    const paymentMethodRadio = document.querySelector('input[name="paymentMethod"]:checked');

    if (!paymentMethodRadio) {
      showErrorPopup("Please select a payment method");
      return;
    }

    const selectedPaymentMethod = paymentMethodRadio.value;
    const cartItems = <%- JSON.stringify(items) %>;

    const orderData = {
      address: selectedAddress,
      paymentMethod: selectedPaymentMethod,
      cartItems,
      totalPrice : finalAmount ? finalAmount : <%= total %>,
    };

    console.log("data beofre order placing >>",orderData )

     // Check COD limit
      if (selectedPaymentMethod === 'cashonDelivery' && orderData.totalPrice > 6000) {
        showErrorPopup("Cash on Delivery available for orders below ₹6000.");

        return;
     }

    try {
      const response = await axios.post('/orderPlacing', orderData);
      console.log(response);


      const razorpayKey = "<%= razorpayKey %>";
      const orderId = response.data.orderId;

      if (selectedPaymentMethod === 'paypal') {
        const options = {
          key: razorpayKey,
          amount: response.data.amount,
          currency: 'INR',
          name: 'CUST E-commerce',
          description: 'Order Payment',
          order_id: orderId,
          handler: async (paymentResponse) => {
            try {
              const verifyResponse = await axios.post('/verifyPayment', {
                razorpayPaymentId: paymentResponse.razorpay_payment_id,
                razorpayOrderId: response.data.id,
                razorpaySignature: paymentResponse.razorpay_signature,
              });
              window.location.href = `/orderConfirm/${verifyResponse.data.razorpayOrderId}`;
            } catch (error) {
              console.error("Payment verification failed:", error);
              showErrorPopup("Payment verification failed. Please contact support.");
            }
          },
          prefill: {
            name: 'Anees',
            email: 'anees@example.com',
            contact: '9999999999',
          },
          theme: {
            color: '#3399cc',
          },
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } else {
    showSuccessPopup("✔ Order placed successfully!");
        window.location.href = `/orderConfirm/${response.data.orderId}`;
      }
    } catch (error) {
      
      if (error.response.data.error === "insufficient_balance") {
        showErrorPopup("Insufficient balance ,Please choose  different.");
      return;
    }
      console.log("Error placing order:", error);
      showErrorPopup("Failed to place the order. Please try again.")
    }
  });

  // ---------------------------------- Coupon Section ----------------------------------
  document.addEventListener("DOMContentLoaded", () => {
  const applyCouponBtn = document.getElementById("apply-coupon-btn");
  const removeCouponBtn = document.getElementById("remove-coupon-btn");
  const couponCodeInput = document.getElementById("coupon-code");
  const couponMessage = document.getElementById("coupon-message");
  const appliedCouponMessage = document.getElementById("applied-coupon-message");
  const applySection = document.getElementById("apply-coupon-section");
  const removeSection = document.getElementById("remove-coupon-section");
  const couponDiscountofordersection = document.getElementById("couponDiscount")
  const finalTotalofordersection = document.getElementById("finalTotal")

  // Handle Apply Coupon
  applyCouponBtn.addEventListener("click", async () => {
    const couponCode = couponCodeInput.value.trim();

    if (!couponCode) {
      couponMessage.textContent = "Please enter a coupon code.";
      return;
    }

    try {
    

      // Axios POST request
      const response = await axios.post("/apply-coupon?checkoutTotal=<%=total%>", {
        couponCode,
      });

      const data = response.data;
      finalAmount = data.finalTotal

      if (data.success) {
        // Coupon applied successfully
        applySection.style.display = "none";
        removeSection.style.display = "block";

        appliedCouponMessage.textContent = `Coupon Applied! Discount: ₹${data.discount}, Final Total: ₹${data.finalTotal}`;
        couponDiscountofordersection.textContent = `${data.discount}`
        finalTotalofordersection.textContent = ` ${data.finalTotal}`
      } else {
        // Coupon application failed
        couponMessage.textContent = data.message;
      }
    } catch (error) {
      console.error("Error applying coupon:", error);
      couponMessage.textContent = "An error occurred. Please try again.";
    }
  });

  // Handle Remove Coupon
  removeCouponBtn.addEventListener("click", async () => {
    try {
      // Axios POST request
      const response = await axios.delete(`/remove-coupon`);

      const data = response.data;
      finalAmount = data.finalTotal
     

      if (data.success) {

      
        
        const discountAmount = response.data.discountAmount; // Backend sends the discount amount
      const currentTotal = parseFloat(document.querySelector('#finalTotal').innerText);

      // Update the total price in the frontend
      const newTotal = currentTotal + discountAmount;
      document.querySelector('#finalTotal').innerText = newTotal.toFixed(2);

      // Update session or UI to reflect the coupon removal
      showErrorPopup("Coupon removed successfully!");
        // Reset coupon section
        applySection.style.display = "block";
        removeSection.style.display = "none";

        couponCodeInput.value = "";
        couponMessage.textContent = "";
        appliedCouponMessage.textContent = "";
      } else {
        console.error("Failed to remove coupon.");
      }
    } catch (error) {
      console.error("Error removing coupon:", error);
    }
  });
});

  // ---------------------------------- Popup Messages ----------------------------------
  function showSuccessPopup(message) {
    const successPopup = document.getElementById('successPopup');
    successPopup.innerText = message;
    successPopup.classList.add('show');
    setTimeout(() => {
      successPopup.classList.remove('show');
    }, 3000);
  }

  function showErrorPopup(message) {
    const errorPopup = document.getElementById('errorPopup');
    errorPopup.innerText = message;
    errorPopup.classList.add('show');
    setTimeout(() => {
      errorPopup.classList.remove('show');
    }, 3000);
  }
</script>

